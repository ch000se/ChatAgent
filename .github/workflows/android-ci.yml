name: Android CI/CD

on:
  push:
    branches: [ master, main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]

env:
  JAVA_VERSION: '17'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  # ===========================================
  # JOB 1: Build and Test
  # ===========================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create local.properties
        run: |
          echo "API_KEY=${{ secrets.API_KEY }}" >> local.properties
          echo "API_URL=${{ secrets.API_URL }}" >> local.properties
          echo "HF_API_KEY=${{ secrets.HF_API_KEY }}" >> local.properties

      - name: Run Lint
        run: ./gradlew lint

      - name: Run Unit Tests
        run: ./gradlew test

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7

      - name: Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-report
          path: app/build/reports/lint-results-debug.html
          retention-days: 7

  # ===========================================
  # JOB 2: Build Release APK (on tags)
  # ===========================================
  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create local.properties
        run: |
          echo "API_KEY=${{ secrets.API_KEY }}" >> local.properties
          echo "API_URL=${{ secrets.API_URL }}" >> local.properties
          echo "HF_API_KEY=${{ secrets.HF_API_KEY }}" >> local.properties

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release-keystore.jks

      - name: Build Release AAB
        run: ./gradlew bundleRelease
        env:
          KEYSTORE_FILE: release-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Build Release APK
        run: ./gradlew assembleRelease
        env:
          KEYSTORE_FILE: release-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Upload Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

  # ===========================================
  # JOB 3: Deploy to Google Play Store
  # ===========================================
  deploy-play-store:
    name: Deploy to Play Store
    runs-on: ubuntu-latest
    needs: build-release
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Release AAB
        uses: actions/download-artifact@v4
        with:
          name: release-aab
          path: app/build/outputs/bundle/release/

      - name: Set up Ruby for Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          gem install fastlane-plugin-versioning_android

      - name: Create Google Play Service Account JSON
        run: |
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" > google-play-key.json

      - name: Deploy to Internal Testing Track
        run: |
          fastlane supply \
            --aab app/build/outputs/bundle/release/app-release.aab \
            --track internal \
            --package_name com.example.chatagent \
            --json_key google-play-key.json \
            --skip_upload_metadata \
            --skip_upload_images \
            --skip_upload_screenshots

      - name: Clean up credentials
        if: always()
        run: rm -f google-play-key.json

  # ===========================================
  # JOB 4: Create GitHub Release
  # ===========================================
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: ./apk

      - name: Download Release AAB
        uses: actions/download-artifact@v4
        with:
          name: release-aab
          path: ./aab

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ./apk/*.apk
            ./aab/*.aab
